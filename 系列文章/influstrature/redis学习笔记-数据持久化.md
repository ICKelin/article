## redis数据持久化

redis是K-V存储系统，最常用的场景是缓存，数据丢失与否无关紧要，但是redis依旧可配置数据持久化到硬盘，支持宕机之后恢复。

本文主要记录了redis的持久化的持久化以及一些思考。

## 如果是你，你会怎么做？
不妨换个角度考虑问题，如果要你去设计一个将缓存持久化的模块，你会怎么做？那么首先就需要考虑以下一些问题？

- 什么时候持久化
- 如何持久化

考虑到Redis是一个单线程运行的服务器，所以在考虑以上问题的时候，最好需要结合单线程这一特性去考虑。

首先第一个问题，什么时候持久化？有两种策略可以考虑：

- 为了防止数据丢失，每当有新数据写入时，则进行初始化
- 如果可以容忍可能造成的短暂数据丢失，可以考虑定时初始化

第一种策略可靠性比较强，当时性能可能不是很高，因为每次写操作都需要同步写入磁盘。第二种策略性能要好些，但是实现复杂度相对会高一些，而且可能会造成数据丢失。

其次第二个问题，如何进行初始化？也有两种策略可以考虑：

- 全量持久化
- 增量持久化

就这这个思路来学习redis是如何做持久化的。

## redis持久化

redis持久化有两种方式：

- RDB
- AOF

RDB方式为镜像的方式，AOF为增量的方式，持久化的方式和时间各不相同

## RDB

## AOF

AOF核心思想是**增量**持久化**写操作**命令，关键词在增量，和写操作。 AOF持久化是在执行命令结束之后才会进行，避免持久化一些失败的命令

AOF有几个弊端需要解决：

- 阻塞主线程，AOF写入是在主线程进行的磁盘操作，因此可能会降低性能
- 丢失数据，命令执行完到写入磁盘这段时间如果redis服务宕机，那么会丢失这一时间的数据
- 磁盘文件太大，AOF是写入的redis命令，以文本的方式存在，因此可能会导致文件过大

### AOF写回策略
以上三个问题当中，前两个问题是通过控制AOF写回的时间来解决的，redis设计了以下三种方式的写回策略：

- 同步写回，相当于把redis当数据库用，性能较低，数据可靠性较高，宕机丢失非常少数据
- 每秒写回，可以理解为收集这一秒内的写命令，每个一秒刷一次盘。中庸思想，性能一般，宕机可能会丢失一秒的数据
- 由操作系统控制写回，性能较高，宕机可能会丢失较多的数据。

三种写回策略各有个的好处和坏处，需要具体问题具体分析，不同的场景使用不同的策略，**但是三种策略都没能保证数据一定不丢失。**

### AOF重写
AOF是按照命令的方式持久化的，也就是说持久化的文件会一直在增大，影响故障恢复，如果从故障当中把AOF文件读取出来，然后一条一条命令执行，那么故障恢复时间就会非常久。

为了解决这个问题，redis设计了AOF重写机制，把多个命令合成为一个命令，比如多个set命令，实际上当前的状态就是最后一个set命令的结果。

当文件达到一定配置值的时候，redis会专门fork一个子进程专门做AOF重写，避免阻塞主线程。

## 总结
